name: Auto Build MRS Rules

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 下载 Mihomo 内核
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo ">>> 下载最新正式版内核 (Compatible)..."
          gh release download --repo MetaCubeX/mihomo --pattern "*linux-amd64-compatible-v*.gz" --output mihomo.gz
          
          gunzip mihomo.gz
          chmod +x mihomo
          
          mkdir -p RULE-SET
          
          echo ">>> 内核版本："
          ./mihomo -v

      - name: 3. 处理 Hagezi Pro Plus
        run: |
          echo ">>> 下载 Hagezi 源文件..."
          curl -sSL "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/pro.plus.txt" -o raw.txt

          echo ">>> 转换为 YAML 格式..."
          echo "payload:" > hagezi_temp.yaml
          grep -vE '^#|^$' raw.txt | sed "s/^/  - '/; s/$/'/" >> hagezi_temp.yaml
          
          echo ">>> 检查 YAML 头部..."
          head -n 5 hagezi_temp.yaml

          echo ">>> 编译为二进制 (.mrs)..."
          # ⚠️⚠️⚠️ 修正点：在 domain 后面加了 yaml
          # 语法: convert-ruleset <行为> <格式> <输入> <输出>
          ./mihomo convert-ruleset domain yaml hagezi_temp.yaml RULE-SET/hagezi_pro_plus.mrs
          
          echo ">>> 验证生成结果："
          ls -lh RULE-SET/hagezi_pro_plus.mrs
          
          rm raw.txt hagezi_temp.yaml

      - name: 4. 处理 Direct (你自己的规则)
        run: |
          if [ -f "direct.yaml" ]; then
            echo ">>> 编译 Direct Rule..."
            # ⚠️⚠️⚠️ 修正点：在 domain 后面加了 yaml
            ./mihomo convert-ruleset domain yaml direct.yaml RULE-SET/direct.mrs
            
            echo ">>> 验证生成结果："
            ls -lh RULE-SET/direct.mrs
          else
            echo "⚠️ 警告：根目录下没找到 direct.yaml，跳过此步骤。"
          fi

      - name: 5. 提交并上传
        run: |
          rm mihomo
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add RULE-SET/*.mrs
          
          git commit -m "Auto-update rules binaries [skip ci]" || exit 0
          git push
