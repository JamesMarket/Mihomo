name: Auto Build MRS Rules

# 触发机制：每天北京时间早上 6:00 (UTC 22:00) 或 手动点击
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

# 权限设置：允许脚本修改仓库文件
permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 下载 Mihomo 内核 (Latest Release)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo ">>> 下载最新正式版内核..."
          gh release download --repo MetaCubeX/mihomo --pattern "*linux-amd64-v*.gz" --output mihomo.gz
          gunzip mihomo.gz
          chmod +x mihomo
          
          # 创建一个空的配置目录，防止编译时报错
          mkdir -p temp_config
          # 创建存放结果的文件夹
          mkdir -p RULE-SET

      - name: 3. 处理 Hagezi Pro Plus (魔法转换 ✨)
        run: |
          echo ">>> 下载 Hagezi 源文件..."
          # 下载纯文本文件
          curl -sSL "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/pro.plus.txt" -o raw.txt

          echo ">>> 转换为 YAML 格式..."
          # 1. 写入头部
          echo "payload:" > hagezi_temp.yaml
          # 2. 文本处理：去除注释(#) -> 去除空行 -> 给每行加缩进和引号 -> 追加到 yaml
          grep -vE '^#|^$' raw.txt | sed "s/^/  - '/; s/$/'/" >> hagezi_temp.yaml

          echo ">>> 编译为二进制 (.mrs)..."
          ./mihomo -d temp_config convert-ruleset domain hagezi_temp.yaml RULE-SET/hagezi_pro_plus.mrs
          
          # 清理临时垃圾
          rm raw.txt hagezi_temp.yaml

      - name: 4. 处理 Direct (你自己的规则)
        run: |
          if [ -f "direct.yaml" ]; then
            echo ">>> 发现 direct.yaml，开始编译..."
            ./mihomo -d temp_config convert-ruleset domain direct.yaml RULE-SET/direct.mrs
          else
            echo "⚠️ 警告：根目录下没找到 direct.yaml，跳过此步骤。"
          fi

      - name: 5. 提交并上传
        run: |
          # 删除内核文件，不上传
          rm mihomo
          rm -rf temp_config

          # 配置 Git 身份
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 强制添加 RULE-SET 目录下的所有 mrs 文件
          git add RULE-SET/*.mrs
          
          # 提交更改 (如果没有变化则跳过)
          git commit -m "Auto-update rules binaries [skip ci]" || exit 0
          git push
