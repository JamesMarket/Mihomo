name: 自动更新规则总数

on:
  push:
    paths:
      - 'RULE-SET/direct.yaml' # 仅当该文件变动时触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 确保有写权限以推回更改

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 计算并更新规则总数
        run: |
          FILE_PATH="RULE-SET/direct.yaml"
          
          # 统计以 "  - " 开头的规则行数
          # 根据 2026 年 2 月 2 日的记录，你已在此文件中定义了此类规则
          COUNT=$(grep -c "^[[:space:]]*- " "$FILE_PATH")
          echo "检测到规则总数: $COUNT"
          
          # 使用 sed 精准替换数字，同时保留前面的空格和文字格式
          # 搜索包含 "# 总规则数: " 的行，并将冒号后的数字替换为变量 $COUNT
          sed -i "s/\(# 总规则数: \)[0-9]*/\1$COUNT/" "$FILE_PATH"

      - name: 自动提交更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 自动更新规则总数为 $COUNT [skip ci]"
          file_pattern: 'RULE-SET/direct.yaml'
