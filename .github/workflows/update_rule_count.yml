name: 万能规则统计器

on:
  push:
    paths:
      - 'RULE-SET/direct.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 动态区间统计与精准更新
        shell: python
        run: |
          import re
          import os

          file_path = "RULE-SET/direct.yaml"
          
          with open(file_path, "r", encoding="utf-8") as f:
              lines = f.readlines()

          # 1. 计算全局总规则数 (以 "- " 开头的行)
          total_rules = sum(1 for line in lines if line.strip().startswith("- "))
          print(f"检测到总规则数: {total_rules}")

          # 2. 更新顶部的总规则数
          for i in range(len(lines)):
              if "# 总规则数" in lines[i]:
                  # 使用 \g<1> 明确分组，避免 \122 这种歧义
                  lines[i] = re.sub(r"(# 总规则数[:：]\s*)\d+", rf"\g<1>{total_rules}", lines[i])
                  break

          # 3. 动态处理分类块
          # 寻找标题行索引，如 # ====== 1. ... ======
          headers = [i for i, line in enumerate(lines) if re.search(r"#\s*======\s*\d+\.", line)]

          for i, start_idx in enumerate(headers):
              # 确定该分类块的搜索范围
              end_idx = headers[i+1] if i + 1 < len(headers) else len(lines)
              
              # 统计该区间内的活跃规则
              section_count = sum(1 for j in range(start_idx, end_idx) if lines[j].strip().startswith("- "))
              
              # 在标题下方的 5 行内寻找 [当前类别统计] 占位符
              for j in range(start_idx + 1, min(start_idx + 6, len(lines))):
                  if "[当前类别统计]" in lines[j]:
                      lines[j] = re.sub(r"(\[当前类别统计\][:：]\s*)\d+", rf"\g<1>{section_count}", lines[j])
                      break

          # 4. 写回文件
          with open(file_path, "w", encoding="utf-8") as f:
              f.writelines(lines)
          
          # 设置环境变量供 commit message 使用
          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
              env_file.write(f"TOTAL_COUNT={total_rules}\n")

      - name: 自动提交更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 自动更新规则统计 (总数: ${{ env.TOTAL_COUNT }}) [skip ci]"
          file_pattern: 'RULE-SET/direct.yaml'
