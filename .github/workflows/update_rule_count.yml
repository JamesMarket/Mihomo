name: 万能规则统计器

on:
  push:
    paths:
      - 'RULE-SET/direct.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 动态区间统计与精准更新
        env:
          LC_ALL: C.UTF-8 # 强制使用 UTF-8 编码处理中文
        run: |
          FILE_PATH="RULE-SET/direct.yaml"
          
          # 1. 计算全局总数
          TOTAL_COUNT=$(grep -c "^[[:space:]]*- " "$FILE_PATH" || echo 0)
          echo "检测到总规则数: $TOTAL_COUNT"
          
          # 使用 @ 作为定界符，-E 启用扩展正则，匹配更稳健
          sed -i -E "s@(# 总规则数[:：][[:space:]]*)[0-9]*@\1$TOTAL_COUNT@" "$FILE_PATH"

          # 2. 获取分类标题的行号
          line_numbers=$(grep -n "#[[:space:]]*======[[:space:]]*[0-9]\+\." "$FILE_PATH" | cut -d: -f1 || true)
          
          if [ -z "$line_numbers" ]; then
            echo "未检测到分类标题，请检查格式。"
          else
            lines=($line_numbers)
            for i in "${!lines[@]}"; do
              start_line=${lines[$i]}
              
              # 确定该分类块的结束行
              if [ $((i+1)) -lt ${#lines[@]} ]; then
                end_line=$((lines[$((i+1))] - 1))
              else
                end_line=$(wc -l < "$FILE_PATH")
              fi
              
              # 统计区间内以 "- " 开头的行
              section_count=$(sed -n "${start_line},${end_line}p" "$FILE_PATH" | grep -c "^[[:space:]]*- " || echo 0)
              
              # 在标题后 5 行内寻找 [当前类别统计] 占位符
              search_limit=$((start_line + 5))
              rel_target=$(sed -n "${start_line},${search_limit}p" "$FILE_PATH" | grep -n "\[当前类别统计\]" | head -n 1 | cut -d: -f1 || true)
              
              if [ ! -z "$rel_target" ]; then
                target_line=$((start_line + rel_target - 1))
                # 精准更新该行的统计数字
                sed -i -E "${target_line}s@(\[当前类别统计\][:：][[:space:]]*)[0-9]*@\1$section_count@" "$FILE_PATH"
              fi
            done
          fi
          
          # 将总数存入环境变量供 Commit Message 使用
          echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV

      - name: 自动提交更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 自动更新规则统计 (活跃总数: ${{ env.TOTAL_COUNT }}) [skip ci]"
          file_pattern: 'RULE-SET/direct.yaml'
